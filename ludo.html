<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ludo - MultiJeuxGo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="tabs">
    <a href="index.html">Jeux</a>
    <a href="classement.html">Classement</a>
    <a href="guide.html">Comment jouer</a>
    <a href="amis.html">Mes amis</a>
  </header>

  <h1>ðŸŽ² Ludo</h1>

  <div class="card">
    <p id="turnInfo">Tour de : ...</p>
    <div id="diceBtn" class="btn">Lancer le dÃ© ðŸŽ²</div>
    <button class="btn" id="joinBtn">Rejoindre cette partie</button>
  </div>

  <div class="card">
    <div id="chatList"></div>
    <input id="chatInput" placeholder="Votre message...">
    <button class="btn" id="chatSend">Envoyer</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
    const firebaseConfig = {
  apiKey: "AIzaSyCL3rtG0CcD4T6XGEGfGtHLU39rp_wsSqA",
  authDomain: "multijeugo.firebaseapp.com",
  projectId: "multijeugo",
  storageBucket: "multijeugo.firebasestorage.app",
  messagingSenderId: "181253022362",
  appId: "1:181253022362:web:3eca9851efdb7541a5f523",
  measurementId: "G-YKC3SHW17Q"
};
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const turnInfo = document.getElementById("turnInfo");
    const diceBtn = document.getElementById("diceBtn");
    const joinBtn = document.getElementById("joinBtn");
    const chatList = document.getElementById("chatList");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");

    const urlParams = new URLSearchParams(window.location.search);
    const partieId = urlParams.get("id") || "ludo-demo";
    const ref = doc(db, "parties", partieId);
    const chatCol = collection(db, "messages", partieId, "items");

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;

      // Ã‰coute de la partie
      onSnapshot(ref, async (snap) => {
        const data = snap.data();
        if (!data) return;
        const joueurActifUid = data.joueurs?.[data.tour];
        const prenomActif = await getPrenom(joueurActifUid);
        turnInfo.textContent = `Tour de : ${prenomActif} (dÃ©: ${data.etat?.de || 0})`;
      });

      // Ã‰coute du chat
      onSnapshot(chatCol, async (snap) => {
        const items = snap.docs.map(d => d.data()).sort((a,b) => a.timestamp - b.timestamp);
        chatList.innerHTML = "";
        for (const m of items) {
          const nom = await getPrenom(m.auteur);
          chatList.innerHTML += `<p><b>${nom}:</b> ${m.texte}</p>`;
        }
      });
    });

    diceBtn.addEventListener("click", async () => {
      const snap = await getDoc(ref);
      const data = snap.data();
      if (!data || !currentUser) return;

      if (currentUser.uid !== data.joueurs?.[data.tour]) {
        alert("â›” Ce n'est pas votre tour !");
        return;
      }

      const de = Math.floor(Math.random() * 6) + 1;
      await setDoc(ref, {
        ...data,
        etat: { ...data.etat, de },
        tour: (data.tour + 1) % data.joueurs.length
      });
    });

    joinBtn.addEventListener("click", async () => {
      const snap = await getDoc(ref);
      const data = snap.data();
      const joueurs = data.joueurs || [];
      if (!joueurs.includes(currentUser.uid)) {
        await setDoc(ref, { joueurs: [...joueurs, currentUser.uid] }, { merge: true });
        alert("âœ… AjoutÃ© Ã  la partie !");
      } else {
        alert("â„¹ï¸ Tu es dÃ©jÃ  dans la partie.");
      }
    });

    chatSend.addEventListener("click", async () => {
      const texte = chatInput.value.trim();
      if (!texte || !currentUser) return;
      await addDoc(chatCol, {
        auteur: currentUser.uid,
        texte,
        timestamp: Date.now()
      });
      chatInput.value = "";
    });

    async function getPrenom(uid) {
      if (!uid) return "...";
      const s = await getDoc(doc(db, "joueurs", uid));
      return s.exists() ? s.data().prenom : "Joueur";
    }
  </script>
</body>
</html>
